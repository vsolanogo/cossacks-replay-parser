!function(){"use strict";const s=/(?:^|\s)UID(\d+).*?gMap name (\S+).*?mapsize (\d+).*?terraintype (\d+).*?relieftype (\d+)/s;self.onmessage=e=>{const t=e.data,a=new FileReader;a.onload=e=>{try{let a=e.target?.result??"";a=a.replace(/[^ -~]+/g," ");const r=s.exec(a);if(!r)throw new Error("Game info not found in file");const n={gameId:r[1],gMapName:r[2],mapSize:parseInt(r[3],10),terrainType:parseInt(r[4],10),reliefType:parseInt(r[5],10),players:[]},c=/(\* id \d+[\s\S]*?)(?=\* id |\bplayersinfo\b|$)/g;let l;const i=[];for(;null!==(l=c.exec(a));)i.push(l[1]);const o=s=>(s??"").replace(/%color\([^\)]*\)%/gi,"").replace(/\s+/g," ").trim().toLowerCase();for(const s of i){const e=s.match(/\* id (\-?\d+)/),t=s.match(/cid (\-?\d+)/),a=s.match(/csid\s+([^\s]+)/),r=s.match(/name\s+([\s\S]*?)\s+team\b/),c=s.match(/team\s+(\-?\d+)/),l=s.match(/color\s+(\-?\d+)/),i=s.match(/lanid\s+(\-?\d+)/),o=s.match(/startx\s+(\-?\d+)/),d=s.match(/starty\s+(\-?\d+)/),m=s.match(/aidifficulty\s+(\-?\d+)/),p=s.match(/bexists\s+(true|false)/),f=s.match(/bai\s+(true|false)/),h=s.match(/bhuman\s+(true|false)/),u=s.match(/bclosed\s+(true|false)/),b=s.match(/bready\s+(true|false)/),g=s.match(/bloaded\s+(true|false)/),y=s.match(/bleave\s+(true|false)/),I={id:e?parseInt(e[1],10):-1,cid:t?parseInt(t[1],10):NaN,csid:a?a[1]:"",name:r?r[1].trim():a?a[1]:"",team:c?parseInt(c[1],10):0,color:l?parseInt(l[1],10):0,lanid:i?parseInt(i[1],10):0,startx:o?parseInt(o[1],10):0,starty:d?parseInt(d[1],10):0,aidifficulty:m?parseInt(m[1],10):0,bexists:!!p&&"true"===p[1],bai:!!f&&"true"===f[1],bhuman:!!h&&"true"===h[1],bclosed:!!u&&"true"===u[1],bready:!!b&&"true"===b[1],bloaded:!!g&&"true"===g[1],bleave:!!y&&"true"===y[1]};n.players.push(I)}const d=a.match(/\bplayersinfo\b([\s\S]*?)(?=\bPatternList\b|\bF\b|$)/),m=[];if(d){const s=d[1],e=/(\* sic [\s\S]*?)(?=\* sic |\n\*|$)/g;let t;for(;null!==(t=e.exec(s));){const s=t[1],e=s.match(/sic\s+(\d+)/),a=s.match(/si1\s+(\d+)/),r=s.match(/si2\s+(\d+)/),n=s.match(/si3\s+(\d+)/),c=s.match(/snc\s+([^\s]+)/),l=s.match(/sn1\s+([^\s]+)/),i=s.match(/sn2\s+([^\s]+)/),o=s.match(/sn3\s+([^\s]+)/);m.push({sic:e?parseInt(e[1],10):0,si1:a?parseInt(a[1],10):0,si2:r?parseInt(r[1],10):0,si3:n?parseInt(n[1],10):0,snc:c?c[1]:"",sn1:l?l[1]:"",sn2:i?i[1]:"",sn3:o?o[1]:""})}}const p=new Set,f=new Map;n.players.forEach((s,e)=>{const t=o(s.name);f.has(t)||f.set(t,[]),f.get(t).push(e)});let h=0;for(let s=0;s<m.length;s++){const e=m[s];let t=null;const a=o(e.snc);if(a){const s=f.get(a)??[];for(const e of s)if(!p.has(e)){t=e;break}}if(null===t){for(;h<n.players.length&&p.has(h);)h++;h<n.players.length?(t=h,h++):t=null}if(null!==t&&t>=0&&t<n.players.length){const s=n.players[t];s.sic=e.sic,s.si1=e.si1,s.si2=e.si2,s.si3=e.si3,s.snc=e.snc||void 0,s.sn1=e.sn1||void 0,s.sn2=e.sn2||void 0,s.sn3=e.sn3||void 0,p.add(t)}}a="";const u={fileName:t.name,status:"completed",data:n};self.postMessage(u)}catch(a){const s={fileName:t.name,status:"error",data:null,error:a?.message??"Unknown parsing error"};self.postMessage(s)}},a.onerror=()=>{const s={fileName:t.name,status:"error",data:null,error:"Error reading file"};self.postMessage(s)},a.readAsText(t)}}();
