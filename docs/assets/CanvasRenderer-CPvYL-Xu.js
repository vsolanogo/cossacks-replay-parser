import{D as e,C as t,c as a,d as n,m as r,M as s,e as o,G as i,w as c,T as l,f as h,s as d,h as u,F as p,i as g,j as m,A as x,R as f,k as v}from"./index-CGsj8U53.js";import{R as C,S as y,B as _,a as T,b as w,c as P,A as M,C as b}from"./RenderTargetSystem-CTzHfKTM.js";let S;function createColoredCanvas(t){const a=e.get().createCanvas(6,1),n=a.getContext("2d");return n.fillStyle=t,n.fillRect(0,0,6,1),a}function canUseNewCanvasBlendModes(){if(void 0!==S)return S;try{const t=createColoredCanvas("#ff00ff"),a=createColoredCanvas("#ffff00"),n=e.get().createCanvas(6,1).getContext("2d");n.globalCompositeOperation="multiply",n.drawImage(t,0,0),n.drawImage(a,2,0);const r=n.getImageData(2,0,1,1);if(r){const e=r.data;S=255===e[0]&&0===e[1]&&0===e[2]}else S=!1}catch(t){S=!1}return S}const k={canvas:null,convertTintToImage:!1,cacheStepsPerColorChannel:8,canUseMultiply:canUseNewCanvasBlendModes(),tintMethod:null,_canvasSourceCache:new WeakMap,_unpremultipliedCache:new WeakMap,getCanvasSource:t=>{const a=t.source,n=a?.resource;if(!n)return null;const r="premultiplied-alpha"===a.alphaMode,s=a.resourceWidth??a.pixelWidth,o=a.resourceHeight??a.pixelHeight,i=s!==a.pixelWidth||o!==a.pixelHeight;if(r){if((n instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&n instanceof OffscreenCanvas)&&!i)return n;const e=k._unpremultipliedCache.get(a);if(e?.resourceId===a._resourceId)return e.canvas}if(n instanceof Uint8Array||n instanceof Uint8ClampedArray||n instanceof Int8Array||n instanceof Uint16Array||n instanceof Int16Array||n instanceof Uint32Array||n instanceof Int32Array||n instanceof Float32Array||n instanceof ArrayBuffer){const t=k._canvasSourceCache.get(a);if(t?.resourceId===a._resourceId)return t.canvas;const r=e.get().createCanvas(a.pixelWidth,a.pixelHeight),s=r.getContext("2d"),o=s.createImageData(a.pixelWidth,a.pixelHeight),i=o.data,c=n instanceof ArrayBuffer?new Uint8Array(n):new Uint8Array(n.buffer,n.byteOffset,n.byteLength);if("bgra8unorm"===a.format)for(let e=0;e<i.length&&e+3<c.length;e+=4)i[e]=c[e+2],i[e+1]=c[e+1],i[e+2]=c[e],i[e+3]=c[e+3];else i.set(c.subarray(0,i.length));return s.putImageData(o,0,0),k._canvasSourceCache.set(a,{canvas:r,resourceId:a._resourceId}),r}if(r){const t=e.get().createCanvas(a.pixelWidth,a.pixelHeight),r=t.getContext("2d",{willReadFrequently:!0});t.width=a.pixelWidth,t.height=a.pixelHeight,r.drawImage(n,0,0);const s=r.getImageData(0,0,t.width,t.height),o=s.data;for(let e=0;e<o.length;e+=4){const t=o[e+3];if(t>0){const a=255/t;o[e]=Math.min(255,o[e]*a+.5),o[e+1]=Math.min(255,o[e+1]*a+.5),o[e+2]=Math.min(255,o[e+2]*a+.5)}}return r.putImageData(s,0,0),k._unpremultipliedCache.set(a,{canvas:t,resourceId:a._resourceId}),t}if(i){const t=k._canvasSourceCache.get(a);if(t?.resourceId===a._resourceId)return t.canvas;const r=e.get().createCanvas(a.pixelWidth,a.pixelHeight),s=r.getContext("2d");return r.width=a.pixelWidth,r.height=a.pixelHeight,s.drawImage(n,0,0),k._canvasSourceCache.set(a,{canvas:r,resourceId:a._resourceId}),r}return n},getTintedCanvas:(a,n)=>{const r=a.texture,s=t.shared.setValue(n).toHex(),o=r.tintCache||(r.tintCache={}),i=o[s],c=r.source._resourceId;if(i?.tintId===c)return i;const l=i&&"getContext"in i?i:e.get().createCanvas();return k.tintMethod(r,n,l),l.tintId=c,o[s]=l,o[s]},getTintedPattern:(a,n)=>{const r=t.shared.setValue(n).toHex(),s=a.patternCache||(a.patternCache={}),o=a.source._resourceId;let i=s[r];if(i?.tintId===o)return i;k.canvas||(k.canvas=e.get().createCanvas()),k.tintMethod(a,n,k.canvas);return i=k.canvas.getContext("2d").createPattern(k.canvas,"repeat"),i.tintId=o,s[r]=i,i},applyPatternTransform:(e,t,a=!0)=>{if(!t)return;const n=e;if(!n.setTransform)return;const r=globalThis.DOMMatrix;if(!r)return;const s=new r([t.a,t.b,t.c,t.d,t.tx,t.ty]);n.setTransform(a?s.inverse():s)},tintWithMultiply:(e,n,r)=>{const s=r.getContext("2d"),o=e.frame.clone(),i=e.source._resolution??e.source.resolution??1,c=e.rotate;o.x*=i,o.y*=i,o.width*=i,o.height*=i;const l=a.isVertical(c),h=l?o.height:o.width,d=l?o.width:o.height;r.width=Math.ceil(h),r.height=Math.ceil(d),s.save(),s.fillStyle=t.shared.setValue(n).toHex(),s.fillRect(0,0,h,d),s.globalCompositeOperation="multiply";const u=k.getCanvasSource(e);u?(c&&k._applyInverseRotation(s,c,o.width,o.height),s.drawImage(u,o.x,o.y,o.width,o.height,0,0,o.width,o.height),s.globalCompositeOperation="destination-atop",s.drawImage(u,o.x,o.y,o.width,o.height,0,0,o.width,o.height),s.restore()):s.restore()},tintWithOverlay:(e,n,r)=>{const s=r.getContext("2d"),o=e.frame.clone(),i=e.source._resolution??e.source.resolution??1,c=e.rotate;o.x*=i,o.y*=i,o.width*=i,o.height*=i;const l=a.isVertical(c),h=l?o.height:o.width,d=l?o.width:o.height;r.width=Math.ceil(h),r.height=Math.ceil(d),s.save(),s.globalCompositeOperation="copy",s.fillStyle=t.shared.setValue(n).toHex(),s.fillRect(0,0,h,d),s.globalCompositeOperation="destination-atop";const u=k.getCanvasSource(e);u?(c&&k._applyInverseRotation(s,c,o.width,o.height),s.drawImage(u,o.x,o.y,o.width,o.height,0,0,o.width,o.height),s.restore()):s.restore()},tintWithPerPixel:(e,t,n)=>{const r=n.getContext("2d"),s=e.frame.clone(),o=e.source._resolution??e.source.resolution??1,i=e.rotate;s.x*=o,s.y*=o,s.width*=o,s.height*=o;const c=a.isVertical(i),l=c?s.height:s.width,h=c?s.width:s.height;n.width=Math.ceil(l),n.height=Math.ceil(h),r.save(),r.globalCompositeOperation="copy";const d=k.getCanvasSource(e);if(!d)return void r.restore();i&&k._applyInverseRotation(r,i,s.width,s.height),r.drawImage(d,s.x,s.y,s.width,s.height,0,0,s.width,s.height),r.restore();const u=t>>16&255,p=t>>8&255,g=255&t,m=r.getImageData(0,0,l,h),x=m.data;for(let a=0;a<x.length;a+=4)x[a]=x[a]*u/255,x[a+1]=x[a+1]*p/255,x[a+2]=x[a+2]*g/255;r.putImageData(m,0,0)},_applyInverseRotation:(e,t,n,r)=>{const s=a.inv(t),o=a.uX(s),i=a.uY(s),c=a.vX(s),l=a.vY(s),h=-Math.min(0,o*n,c*r,o*n+c*r),d=-Math.min(0,i*n,l*r,i*n+l*r);e.transform(o,i,c,l,h,d)}};k.tintMethod=k.canUseMultiply?k.tintWithMultiply:k.tintWithPerPixel;const I=class _CanvasBatchAdaptor2{static _getPatternRepeat(e,t){const a=e&&"clamp-to-edge"!==e,n=t&&"clamp-to-edge"!==t;return a&&n?"repeat":a?"repeat-x":n?"repeat-y":"no-repeat"}start(e,t,a){}execute(e,t){const s=t.elements;if(!s||!s.length)return;const o=e.renderer,i=o.canvasContext,c=i.activeContext;for(let l=0;l<s.length;l++){const e=s[l];if(!e.packAsQuad)continue;const h=e,d=h.texture,u=d?k.getCanvasSource(d):null;if(!u)continue;const p=d.source.style,g=i.smoothProperty,m="nearest"!==p.scaleMode;c[g]!==m&&(c[g]=m),i.setBlendMode(t.blendMode);const x=o.globalUniforms.globalUniformData?.worldColor??4294967295,f=h.color,v=(x>>>24&255)/255*((f>>>24&255)/255)*(o.filter?.alphaMultiplier??1);if(v<=0)continue;c.globalAlpha=v;const C=n(r(16777215&f,16777215&x)),y=d.frame,_=p.addressModeU??p.addressMode,T=p.addressModeV??p.addressMode,w=_CanvasBatchAdaptor2._getPatternRepeat(_,T),P=d.source._resolution??d.source.resolution??1,M=h.renderable?.renderGroup?.isCachedAsTexture,b=y.x*P,S=y.y*P,I=y.width*P,R=y.height*P,A=h.bounds,B=o.renderTarget.renderTarget.isRoot,H=A.minX,W=A.minY,O=A.maxX-A.minX,U=A.maxY-A.minY,E=d.rotate,D=d.uvs,G=Math.min(D.x0,D.x1,D.x2,D.x3,D.y0,D.y1,D.y2,D.y3),F=Math.max(D.x0,D.x1,D.x2,D.x3,D.y0,D.y1,D.y2,D.y3),L="no-repeat"!==w&&(G<0||F>1),V=E&&!(!L&&(16777215!==C||E));V?(_CanvasBatchAdaptor2._tempPatternMatrix.copyFrom(h.transform),a.matrixAppendRotationInv(_CanvasBatchAdaptor2._tempPatternMatrix,E,H,W,O,U),i.setContextTransform(_CanvasBatchAdaptor2._tempPatternMatrix,1===h.roundPixels,void 0,M&&B)):i.setContextTransform(h.transform,1===h.roundPixels,void 0,M&&B);const q=V?0:H,N=V?0:W,j=O,Y=U;if(L){let e=u;const t=16777215!==C&&!E,a=y.width<=d.source.width&&y.height<=d.source.height;t&&a&&(e=k.getTintedCanvas({texture:d},C));const n=c.createPattern(e,w);if(!n)continue;const r=j,s=Y;if(0===r||0===s)continue;const o=1/r,i=1/s,l=(D.x1-D.x0)*o,h=(D.y1-D.y0)*o,p=(D.x3-D.x0)*i,g=(D.y3-D.y0)*i,m=D.x0-l*q-p*N,x=D.y0-h*q-g*N,f=d.source.pixelWidth,v=d.source.pixelHeight;_CanvasBatchAdaptor2._tempPatternMatrix.set(l*f,h*v,p*f,g*v,m*f,x*v),k.applyPatternTransform(n,_CanvasBatchAdaptor2._tempPatternMatrix),c.fillStyle=n,c.fillRect(q,N,j,Y)}else{const e=16777215!==C||E?k.getTintedCanvas({texture:d},C):u,t=e!==u;c.drawImage(e,t?0:b,t?0:S,t?e.width:I,t?e.height:R,q,N,j,Y)}}}};I._tempPatternMatrix=new s,I.extension={type:[o.CanvasPipesAdaptor],name:"batch"};let R=I;class CanvasColorMaskPipe{constructor(e){this._colorStack=[],this._colorStackIndex=0,this._currentColor=0,this._renderer=e}buildStart(){this._colorStack[0]=15,this._colorStackIndex=1,this._currentColor=15}push(e,t,a){this._renderer.renderPipes.batch.break(a);const n=this._colorStack;n[this._colorStackIndex]=n[this._colorStackIndex-1]&e.mask;const r=this._colorStack[this._colorStackIndex];r!==this._currentColor&&(this._currentColor=r,a.add({renderPipeId:"colorMask",colorMask:r,canBundle:!1})),this._colorStackIndex++}pop(e,t,a){this._renderer.renderPipes.batch.break(a);const n=this._colorStack;this._colorStackIndex--;const r=n[this._colorStackIndex-1];r!==this._currentColor&&(this._currentColor=r,a.add({renderPipeId:"colorMask",colorMask:r,canBundle:!1}))}execute(e){}destroy(){this._renderer=null,this._colorStack=null}}function buildShapePath$1(e,t){switch(t.type){case"rectangle":{const a=t;e.rect(a.x,a.y,a.width,a.height);break}case"roundedRectangle":{const a=t;!function buildRoundedRectPath$1(e,t,a,n,r,s){s=Math.max(0,Math.min(s,Math.min(n,r)/2)),e.moveTo(t+s,a),e.lineTo(t+n-s,a),e.quadraticCurveTo(t+n,a,t+n,a+s),e.lineTo(t+n,a+r-s),e.quadraticCurveTo(t+n,a+r,t+n-s,a+r),e.lineTo(t+s,a+r),e.quadraticCurveTo(t,a+r,t,a+r-s),e.lineTo(t,a+s),e.quadraticCurveTo(t,a,t+s,a)}(e,a.x,a.y,a.width,a.height,a.radius);break}case"circle":{const a=t;e.moveTo(a.x+a.radius,a.y),e.arc(a.x,a.y,a.radius,0,2*Math.PI);break}case"ellipse":{const a=t;e.ellipse?(e.moveTo(a.x+a.halfWidth,a.y),e.ellipse(a.x,a.y,a.halfWidth,a.halfHeight,0,0,2*Math.PI)):(e.save(),e.translate(a.x,a.y),e.scale(a.halfWidth,a.halfHeight),e.moveTo(1,0),e.arc(0,0,1,0,2*Math.PI),e.restore());break}case"triangle":{const a=t;e.moveTo(a.x,a.y),e.lineTo(a.x2,a.y2),e.lineTo(a.x3,a.y3),e.closePath();break}default:{const a=t,n=a.points;if(!n?.length)break;e.moveTo(n[0],n[1]);for(let t=2;t<n.length;t+=2)e.lineTo(n[t],n[t+1]);a.closePath&&e.closePath();break}}}function addHolePaths$1(e,t){if(!t?.length)return!1;for(let a=0;a<t.length;a++){const n=t[a];if(!n?.shape)continue;const r=n.transform,s=r&&!r.isIdentity();s&&(e.save(),e.transform(r.a,r.b,r.c,r.d,r.tx,r.ty)),buildShapePath$1(e,n.shape),s&&e.restore()}return!0}CanvasColorMaskPipe.extension={type:[o.CanvasPipes],name:"colorMask"};class CanvasStencilMaskPipe{constructor(e){this._warnedMaskTypes=new Set,this._canvasMaskStack=[],this._renderer=e}push(e,t,a){this._renderer.renderPipes.batch.break(a),a.add({renderPipeId:"stencilMask",action:"pushMaskBegin",mask:e,inverse:t._maskOptions.inverse,canBundle:!1})}pop(e,t,a){this._renderer.renderPipes.batch.break(a),a.add({renderPipeId:"stencilMask",action:"popMaskEnd",mask:e,inverse:t._maskOptions.inverse,canBundle:!1})}execute(e){if("pushMaskBegin"!==e.action&&"popMaskEnd"!==e.action)return;const t=this._renderer,a=t.canvasContext,n=a?.activeContext;if(!n)return;if("popMaskEnd"===e.action){return void(this._canvasMaskStack.pop()&&n.restore())}e.inverse&&this._warnOnce("inverse","CanvasRenderer: inverse masks are not supported on Canvas2D; ignoring inverse flag.");const r=e.mask.mask;if(!(r instanceof i))return this._warnOnce("nonGraphics","CanvasRenderer: only Graphics masks are supported in Canvas2D; skipping mask."),void this._canvasMaskStack.push(!1);const s=r,o=s.context?.instructions;if(!o?.length)return void this._canvasMaskStack.push(!1);n.save(),a.setContextTransform(s.groupTransform,1===(t._roundPixels|s._roundPixels)),n.beginPath();let c=!1,l=!1;for(let i=0;i<o.length;i++){const e=o[i],t=e.action;if("fill"!==t&&"stroke"!==t)continue;const a=e.data,r=a?.path?.shapePath;if(!r?.shapePrimitives?.length)continue;const s=r.shapePrimitives;for(let o=0;o<s.length;o++){const e=s[o];if(!e?.shape)continue;const t=e.transform,a=t&&!t.isIdentity();a&&(n.save(),n.transform(t.a,t.b,t.c,t.d,t.tx,t.ty)),buildShapePath$1(n,e.shape),l=addHolePaths$1(n,e.holes)||l,c=!0,a&&n.restore()}}if(!c)return n.restore(),void this._canvasMaskStack.push(!1);l?n.clip("evenodd"):n.clip(),this._canvasMaskStack.push(!0)}destroy(){this._renderer=null,this._warnedMaskTypes=null,this._canvasMaskStack=null}_warnOnce(e,t){this._warnedMaskTypes.has(e)||(this._warnedMaskTypes.add(e),c(t))}}CanvasStencilMaskPipe.extension={type:[o.CanvasPipes],name:"stencilMask"};const A="source-over";const B=new s;class CanvasContextSystem{constructor(e){this.activeResolution=1,this.smoothProperty="imageSmoothingEnabled",this.blendModes=function mapCanvasBlendModesToPixi(){const e=canUseNewCanvasBlendModes(),t=Object.create(null);return t.inherit=A,t.none=A,t.normal="source-over",t.add="lighter",t.multiply=e?"multiply":A,t.screen=e?"screen":A,t.overlay=e?"overlay":A,t.darken=e?"darken":A,t.lighten=e?"lighten":A,t["color-dodge"]=e?"color-dodge":A,t["color-burn"]=e?"color-burn":A,t["hard-light"]=e?"hard-light":A,t["soft-light"]=e?"soft-light":A,t.difference=e?"difference":A,t.exclusion=e?"exclusion":A,t.saturation=e?"saturation":A,t.color=e?"color":A,t.luminosity=e?"luminosity":A,t["linear-burn"]=e?"color-burn":A,t["linear-dodge"]=e?"color-dodge":A,t["linear-light"]=e?"hard-light":A,t["pin-light"]=e?"hard-light":A,t["vivid-light"]=e?"hard-light":A,t["hard-mix"]=A,t.negation=e?"difference":A,t["normal-npm"]=t.normal,t["add-npm"]=t.add,t["screen-npm"]=t.screen,t.erase="destination-out",t.subtract=A,t.divide=A,t.min=A,t.max=A,t}(),this._activeBlendMode="normal",this._projTransform=null,this._outerBlend=!1,this._warnedBlendModes=new Set,this._renderer=e}resolutionChange(e){this.activeResolution=e}init(){const e=this._renderer.background.alpha<1;if(this.rootContext=this._renderer.canvas.getContext("2d",{alpha:e}),this.activeContext=this.rootContext,this.activeResolution=this._renderer.resolution,!this.rootContext.imageSmoothingEnabled){const e=this.rootContext;e.webkitImageSmoothingEnabled?this.smoothProperty="webkitImageSmoothingEnabled":e.mozImageSmoothingEnabled?this.smoothProperty="mozImageSmoothingEnabled":e.oImageSmoothingEnabled?this.smoothProperty="oImageSmoothingEnabled":e.msImageSmoothingEnabled&&(this.smoothProperty="msImageSmoothingEnabled")}}setContextTransform(e,t,a,n){const r=n?s.IDENTITY:this._renderer.globalUniforms.globalUniformData?.worldTransformMatrix||s.IDENTITY;let o=B;o.copyFrom(r),o.append(e);const i=this._projTransform,c=this.activeResolution;if(a=a||c,i){const e=s.shared;e.copyFrom(o),e.prepend(i),o=e}t?this.activeContext.setTransform(o.a*a,o.b*a,o.c*a,o.d*a,o.tx*c|0,o.ty*c|0):this.activeContext.setTransform(o.a*a,o.b*a,o.c*a,o.d*a,o.tx*c,o.ty*c)}clear(e,a){const n=this.activeContext,r=this._renderer;if(n.clearRect(0,0,r.width,r.height),e){const s=t.shared.setValue(e);n.globalAlpha=a??s.alpha,n.fillStyle=s.toHex(),n.fillRect(0,0,r.width,r.height),n.globalAlpha=1}}setBlendMode(e){if(this._activeBlendMode===e)return;this._activeBlendMode=e,this._outerBlend=!1;const t=this.blendModes[e];if(!t)return this._warnedBlendModes.has(e)||this._warnedBlendModes.add(e),void(this.activeContext.globalCompositeOperation="source-over");this.activeContext.globalCompositeOperation=t}destroy(){this.rootContext=null,this.activeContext=null,this._warnedBlendModes.clear()}}CanvasContextSystem.extension={type:[o.CanvasSystem],name:"canvasContext"};class CanvasLimitsSystem{constructor(){this.maxTextures=16,this.maxBatchableTextures=16,this.maxUniformBindings=0}init(){}}CanvasLimitsSystem.extension={type:[o.CanvasSystem],name:"limits"};const H=new s,W=new s,O=new s,U=new s;function fillTriangles(e,t,a){e.beginPath();for(let n=0;n<a.length;n+=3){const r=2*a[n],s=2*a[n+1],o=2*a[n+2];e.moveTo(t[r],t[r+1]),e.lineTo(t[s],t[s+1]),e.lineTo(t[o],t[o+1]),e.closePath()}e.fill()}function buildShapePath(e,t){switch(t.type){case"rectangle":{const a=t;e.rect(a.x,a.y,a.width,a.height);break}case"roundedRectangle":{const a=t;!function buildRoundedRectPath(e,t,a,n,r,s){s=Math.max(0,Math.min(s,Math.min(n,r)/2)),e.moveTo(t+s,a),e.lineTo(t+n-s,a),e.quadraticCurveTo(t+n,a,t+n,a+s),e.lineTo(t+n,a+r-s),e.quadraticCurveTo(t+n,a+r,t+n-s,a+r),e.lineTo(t+s,a+r),e.quadraticCurveTo(t,a+r,t,a+r-s),e.lineTo(t,a+s),e.quadraticCurveTo(t,a,t+s,a)}(e,a.x,a.y,a.width,a.height,a.radius);break}case"circle":{const a=t;e.arc(a.x,a.y,a.radius,0,2*Math.PI);break}case"ellipse":{const a=t;e.ellipse?e.ellipse(a.x,a.y,a.halfWidth,a.halfHeight,0,0,2*Math.PI):(e.save(),e.translate(a.x,a.y),e.scale(a.halfWidth,a.halfHeight),e.arc(0,0,1,0,2*Math.PI),e.restore());break}case"triangle":{const a=t;e.moveTo(a.x,a.y),e.lineTo(a.x2,a.y2),e.lineTo(a.x3,a.y3),e.closePath();break}default:{const a=t,n=a.points;if(!n?.length)break;e.moveTo(n[0],n[1]);for(let t=2;t<n.length;t+=2)e.lineTo(n[t],n[t+1]);a.closePath&&e.closePath();break}}}function addHolePaths(e,t){if(!t?.length)return!1;for(let a=0;a<t.length;a++){const n=t[a];if(!n?.shape)continue;const r=n.transform,s=r&&!r.isIdentity();s&&(e.save(),e.transform(r.a,r.b,r.c,r.d,r.tx,r.ty)),buildShapePath(e,n.shape),s&&e.restore()}return!0}function getCanvasStyle(e,t,a,n){const r=e.fill;if(r instanceof p){r.buildGradient();const s=r.texture;if(s){const o=k.getTintedPattern(s,t),i=a?U.copyFrom(a).scale(s.source.pixelWidth,s.source.pixelHeight):U.copyFrom(r.transform);return n&&!e.textureSpace&&i.append(n),k.applyPatternTransform(o,i),o}}if(r instanceof g){const e=k.getTintedPattern(r.texture,t);return k.applyPatternTransform(e,r.transform),e}const s=e.texture;if(s&&s!==l.WHITE){if(!s.source.resource)return"#808080";const n=k.getTintedPattern(s,t),r=a?U.copyFrom(a).scale(s.source.pixelWidth,s.source.pixelHeight):e.matrix;return k.applyPatternTransform(n,r),n}return function colorToHex(e){return`#${(16777215&e).toString(16).padStart(6,"0")}`}(t)}class CanvasGraphicsAdaptor{constructor(){this.shader=null}contextChange(e){}execute(e,t){const s=e.renderer,o=s.canvasContext,i=o.activeContext,c=t.groupTransform,p=s.globalUniforms.globalUniformData?.worldColor??4294967295,g=t.groupColorAlpha,m=(p>>>24&255)/255*((g>>>24&255)/255)*(s.filter?.alphaMultiplier??1);if(m<=0)return;const x=n(r(16777215&g,16777215&p)),f=s._roundPixels|t._roundPixels;i.save(),o.setContextTransform(c,1===f),o.setBlendMode(t.groupBlendMode);const v=t.context.instructions;for(let n=0;n<v.length;n++){const e=v[n];if("texture"===e.action){const t=e.data,n=t.image,s=n?k.getCanvasSource(n):null;if(!s)continue;const l=t.alpha*m;if(l<=0)continue;const h=r(t.style,x);i.globalAlpha=l;let d=s;16777215!==h&&(d=k.getTintedCanvas({texture:n},h));const u=n.frame,p=n.source._resolution??n.source.resolution??1;let g=u.x*p,v=u.y*p;const C=u.width*p,y=u.height*p;d!==s&&(g=0,v=0);const _=t.transform,T=_&&!_.isIdentity(),w=n.rotate;T||w?(H.copyFrom(c),T&&H.append(_),w&&a.matrixAppendRotationInv(H,w,t.dx,t.dy,t.dw,t.dh),o.setContextTransform(H,1===f)):o.setContextTransform(c,1===f),i.drawImage(d,g,v,d===s?C:d.width,d===s?y:d.height,w?0:t.dx,w?0:t.dy,t.dw,t.dh),(T||w)&&o.setContextTransform(c,1===f);continue}const t=e.data,s=t?.path?.shapePath;if(!s?.shapePrimitives?.length)continue;const p=t.style,g=r(p.color,x),C=p.alpha*m;if(C<=0)continue;const y="stroke"===e.action;if(i.globalAlpha=C,y){const e=p;i.lineWidth=e.width,i.lineCap=e.cap,i.lineJoin=e.join,i.miterLimit=e.miterLimit}const _=s.shapePrimitives;if(!y&&t.hole?.shapePath?.shapePrimitives?.length){_[_.length-1].holes=t.hole.shapePath.shapePrimitives}for(let a=0;a<_.length;a++){const e=_[a];if(!e?.shape)continue;const t=e.transform,n=t&&!t.isIdentity(),r=p.texture&&p.texture!==l.WHITE,s="global"===p.textureSpace?t:null,o=getCanvasStyle(p,g,r?h(W,p,e.shape,s):null,n?O.copyFrom(c).append(t):c);if(n&&(i.save(),i.transform(t.a,t.b,t.c,t.d,t.tx,t.ty)),y){const t=p;if(.5!==t.alignment&&!t.pixelLine){const a=[],n=[],r=[],s=d[e.shape.type];if(s?.build(e.shape,a)){const s=e.shape.closePath??!0;u(a,t,!1,s,n,r),i.fillStyle=o,fillTriangles(i,n,r)}else i.strokeStyle=o,i.beginPath(),buildShapePath(i,e.shape),i.stroke()}else i.strokeStyle=o,i.beginPath(),buildShapePath(i,e.shape),i.stroke()}else{i.fillStyle=o,i.beginPath(),buildShapePath(i,e.shape);addHolePaths(i,e.holes)?i.fill("evenodd"):i.fill()}n&&i.restore()}}i.restore()}destroy(){this.shader=null}}CanvasGraphicsAdaptor.extension={type:[o.CanvasPipesAdaptor],name:"graphics"};class CanvasRenderTargetAdaptor{init(e,t){this._renderer=e,this._renderTargetSystem=t}initGpuRenderTarget(e){const t=e.colorTexture,{canvas:a,context:n}=this._ensureCanvas(t);return{canvas:a,context:n,width:a.width,height:a.height}}resizeGpuRenderTarget(e){const t=e.colorTexture,{canvas:a}=this._ensureCanvas(t);a.width=e.pixelWidth,a.height=e.pixelHeight}startRenderPass(e,t,a,n){const r=this._renderTargetSystem.getGpuRenderTarget(e);this._renderer.canvasContext.activeContext=r.context,this._renderer.canvasContext.activeResolution=e.resolution,t&&this.clear(e,t,a,n)}clear(e,a,n,r){const s=this._renderTargetSystem.getGpuRenderTarget(e).context,o=r||{x:0,y:0,width:e.pixelWidth,height:e.pixelHeight};if(s.setTransform(1,0,0,1,0,0),s.clearRect(o.x,o.y,o.width,o.height),n){const e=t.shared.setValue(n);e.alpha>0&&(s.globalAlpha=e.alpha,s.fillStyle=e.toHex(),s.fillRect(o.x,o.y,o.width,o.height),s.globalAlpha=1)}}finishRenderPass(){}copyToTexture(e,t,a,n,r){const s=this._renderTargetSystem.getGpuRenderTarget(e).canvas,o=t.source,{context:i}=this._ensureCanvas(o),c=r?.x??0,l=r?.y??0;return i.drawImage(s,a.x,a.y,n.width,n.height,c,l,n.width,n.height),o.update(),t}destroyGpuRenderTarget(e){}_ensureCanvas(t){let a=t.resource;a&&m.test(a)||(a=e.get().createCanvas(t.pixelWidth,t.pixelHeight),t.resource=a),a.width===t.pixelWidth&&a.height===t.pixelHeight||(a.width=t.pixelWidth,a.height=t.pixelHeight);const n=a.getContext("2d");return{canvas:a,context:n}}}class CanvasRenderTargetSystem extends C{constructor(e){super(e),this.adaptor=new CanvasRenderTargetAdaptor,this.adaptor.init(e,this)}}CanvasRenderTargetSystem.extension={type:[o.CanvasSystem],name:"renderTarget"};class CanvasTextureSystem{constructor(e){}init(){}initSource(e){}generateCanvas(t){const a=e.get().createCanvas(),n=a.getContext("2d"),r=k.getCanvasSource(t);if(!r)return a;const s=t.frame,o=t.source._resolution??t.source.resolution??1,i=s.x*o,c=s.y*o,l=s.width*o,h=s.height*o;return a.width=Math.ceil(l),a.height=Math.ceil(h),n.drawImage(r,i,c,l,h,0,0,l,h),a}getPixels(e){const t=this.generateCanvas(e);return{pixels:t.getContext("2d",{willReadFrequently:!0}).getImageData(0,0,t.width,t.height).data,width:t.width,height:t.height}}destroy(){}}CanvasTextureSystem.extension={type:[o.CanvasSystem],name:"texture"};const E=[...y,CanvasContextSystem,CanvasLimitsSystem,CanvasTextureSystem,CanvasRenderTargetSystem],D=[_,T,w,P,M,CanvasStencilMaskPipe,CanvasColorMaskPipe,b],G=[R,CanvasGraphicsAdaptor],F=[],L=[],V=[];v.handleByNamedList(o.CanvasSystem,F),v.handleByNamedList(o.CanvasPipes,L),v.handleByNamedList(o.CanvasPipesAdaptor,V),v.add(...E,...D,...G);class CanvasRenderer extends x{constructor(){super({name:"canvas",type:f.CANVAS,systems:F,renderPipes:L,renderPipeAdaptors:V})}}export{CanvasRenderer};
