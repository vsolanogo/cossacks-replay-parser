!function(){"use strict";const s=/(?:^|\s)UID(\d+).*?gMap name (\S+).*?mapsize (\d+).*?terraintype (\d+).*?relieftype (\d+)/s;self.onmessage=e=>{const t=e.data,a=new FileReader;a.onload=e=>{try{let a=e.target?.result??"";a=a.replace(/[^ -~]+/g," ");const n=s.exec(a);if(!n)throw new Error("Game info not found in file");const r={gameId:n[1]??"",gMapName:n[2]??"",mapSize:parseInt(n[3]??"0",10),terrainType:parseInt(n[4]??"0",10),reliefType:parseInt(n[5]??"0",10),players:[]},l=a.match(/\bplayers\b([\s\S]*?)(?=\bplayersinfo\b|\bPatternList\b|\bF\b|$)/);let c=l?.[1]??a;const readNext=(s,e)=>{const t=new RegExp(e.source,e.flags.includes("g")?e.flags:e.flags+"g").exec(s);if(!t)return{value:"",rest:s};const a=t.index+t[0].length;return{value:t[1]??"",rest:s.slice(a)}},o=[];for(let s=0;s<12;s++){const e=readNext(c,/cid\s+(-?\d+)/);c=e.rest;const t=readNext(c,/csid\s+([^\s]+)/);c=t.rest;const a=new RegExp(/name\s+([\s\S]*?)\s+team\b/.source,"m").exec(c);let n="";if(a){n=a[1]?.trim()??"";const s=a.index+a[0].length-4;c=c.slice(s)}else{const s=readNext(c,/name\s+([^\s]+)/);n=s.value||"",c=s.rest}const r=readNext(c,/team\s+(-?\d+)/);c=r.rest;const l=readNext(c,/color\s+(-?\d+)/);c=l.rest;const i=readNext(c,/lanid\s+(-?\d+)/);c=i.rest;const u=readNext(c,/startx\s+(-?\d+)/);c=u.rest;const d=readNext(c,/starty\s+(-?\d+)/);c=d.rest;const f=readNext(c,/aidifficulty\s+(-?\d+)/);c=f.rest;const p=readNext(c,/bexists\s+(true|false)/);c=p.rest;const m=readNext(c,/bai\s+(true|false)/);c=m.rest;const b=readNext(c,/bhuman\s+(true|false)/);c=b.rest;const g=readNext(c,/bclosed\s+(true|false)/);c=g.rest;const h=readNext(c,/bready\s+(true|false)/);c=h.rest;const v=readNext(c,/bloaded\s+(true|false)/);c=v.rest;const y=readNext(c,/bleave\s+(true|false)/);c=y.rest;const I={id:s,cid:e.value?parseInt(e.value,10):NaN,csid:t.value||"",name:n||t.value||"",team:r.value?parseInt(r.value,10):0,color:l.value?parseInt(l.value,10):0,lanid:i.value?parseInt(i.value,10):0,startx:u.value?parseInt(u.value,10):0,starty:d.value?parseInt(d.value,10):0,aidifficulty:f.value?parseInt(f.value,10):0,bexists:"true"===p.value,bai:"true"===m.value,bhuman:"true"===b.value,bclosed:"true"===g.value,bready:"true"===h.value,bloaded:"true"===v.value,bleave:"true"===y.value};o.push(I)}const i=l?.[1]??a,u=/(\* id \d+[\s\S]*?)(?=\* id |\bplayersinfo\b|$)/g;let d;const f=[];for(;null!==(d=u.exec(i));)d[1]&&f.push(d[1]);const lastGroup=(s,e)=>{let t,a;const n=new RegExp(e.source,e.flags.includes("g")?e.flags:e.flags+"g");for(;null!==(t=n.exec(s));)a=t[1];return a},p=[];for(let s=0;s<f.length;s++){const e=f[s];if(!e)continue;const t=e.match(/\* id (\-?\d+)/),a=lastGroup(e,/cid\s+(-?\d+)/g),n=e.match(/csid\s+([^\s]+)/),r=e.match(/name\s+([\s\S]*?)\s+team\b/),l=lastGroup(e,/team\s+(-?\d+)/g),c=lastGroup(e,/color\s+(-?\d+)/g),o=lastGroup(e,/lanid\s+(-?\d+)/g),i=lastGroup(e,/startx\s+(-?\d+)/g),u=lastGroup(e,/starty\s+(-?\d+)/g),d=lastGroup(e,/aidifficulty\s+(-?\d+)/g),m=e.match(/bexists\s+(true|false)/),b=e.match(/bai\s+(true|false)/),g=e.match(/bhuman\s+(true|false)/),h=e.match(/bclosed\s+(true|false)/),v=e.match(/bready\s+(true|false)/),y=e.match(/bloaded\s+(true|false)/),I=e.match(/bleave\s+(true|false)/),x={id:t?parseInt(t[1]??"0",10):s,cid:null!=a?parseInt(a,10):NaN,csid:n?n[1]??"":"",name:r?r[1]?.trim()??"":n?n[1]??"":"",team:null!=l?parseInt(l,10):0,color:null!=c?parseInt(c,10):0,lanid:null!=o?parseInt(o,10):0,startx:null!=i?parseInt(i,10):0,starty:null!=u?parseInt(u,10):0,aidifficulty:null!=d?parseInt(d,10):0,bexists:!!m&&"true"===m[1],bai:!!b&&"true"===b[1],bhuman:!!g&&"true"===g[1],bclosed:!!h&&"true"===h[1],bready:!!v&&"true"===v[1],bloaded:!!y&&"true"===y[1],bleave:!!I&&"true"===I[1]};p.push(x)}const countExists=s=>s.reduce((s,e)=>s+(e.bexists?1:0),0),m=countExists(p)>countExists(o)?p:o;r.players.push(...m);const b=a.match(/\bplayersinfo\b([\s\S]*?)(?=\bPatternList\b|\bF\b|$)/),g=[];if(b){const s=b[1]??"",e=/(\* sic [\s\S]*?)(?=\* sic |\n\*|$)/g;let t;for(;null!==(t=e.exec(s));){const s=t[1];if(!s)continue;const e=s.match(/sic\s+(\d+)/),a=s.match(/si1\s+(\d+)/),n=s.match(/si2\s+(\d+)/),r=s.match(/si3\s+(\d+)/),l=s.match(/snc\s+([^\s]+)/),c=s.match(/sn1\s+([^\s]+)/),o=s.match(/sn2\s+([^\s]+)/),i=s.match(/sn3\s+([^\s]+)/);g.push({sic:e?parseInt(e[1]||"0",10):0,si1:a?parseInt(a[1]||"0",10):0,si2:n?parseInt(n[1]||"0",10):0,si3:r?parseInt(r[1]||"0",10):0,snc:l?l[1]:void 0,sn1:c?c[1]:void 0,sn2:o?o[1]:void 0,sn3:i?i[1]:void 0})}}const h=new Set,normalizeName=s=>(s??"").replace(/%color\([^\)]*\)%/gi,"").replace(/\s+/g," ").trim().toLowerCase(),v=new Map;r.players.forEach((s,e)=>{const t=normalizeName(s.name);v.has(t)||v.set(t,[]);const a=v.get(t);a&&a.push(e)});let y=0;for(let s=0;s<g.length;s++){const e=g[s];if(!e)continue;let t=null;const a=normalizeName(e.snc);if(a){const s=v.get(a)??[];for(const e of s)if(!h.has(e)){t=e;break}}if(null===t){for(;y<r.players.length&&h.has(y);)y++;y<r.players.length?(t=y,y++):t=null}if(null!==t&&t>=0&&t<r.players.length){const s=r.players[t];s&&(s.sic=e.sic,s.si1=e.si1,s.si2=e.si2,s.si3=e.si3,s.snc=e.snc,s.sn1=e.sn1,s.sn2=e.sn2,s.sn3=e.sn3),h.add(t)}}a="";const I={fileName:t.name,status:"completed",data:r};self.postMessage(I)}catch(a){const s={fileName:t.name,status:"error",data:null,error:a?.message??"Unknown parsing error"};self.postMessage(s)}},a.onerror=()=>{const s={fileName:t.name,status:"error",data:null,error:"Error reading file"};self.postMessage(s)},a.readAsText(t)}}();
