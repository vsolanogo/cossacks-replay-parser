(function(){"use strict";const V=/(?:^|\s)UID(\d+).*?gMap name (\S+).*?mapsize (\d+).*?terraintype (\d+).*?relieftype (\d+)/s;self.onmessage=j=>{const N=j.data,P=new FileReader;P.onload=$=>{try{let o=$.target?.result??"";o=o.replace(/[^ -~]+/g," ");const b=V.exec(o);if(!b)throw new Error("Game info not found in file");const h={gameId:b[1]??"",gMapName:b[2]??"",mapSize:parseInt(b[3]??"0",10),terrainType:parseInt(b[4]??"0",10),reliefType:parseInt(b[5]??"0",10),players:[]},q=o.match(/\bplayers\b([\s\S]*?)(?=\bplayersinfo\b|\bPatternList\b|\bF\b|$)/);let e=q?.[1]??o;const r=(n,s)=>{const a=new RegExp(s.source,s.flags.includes("g")?s.flags:s.flags+"g").exec(n);if(!a)return{value:"",rest:n};const l=a.index+a[0].length;return{value:a[1]??"",rest:n.slice(l)}},z=[];for(let n=0;n<12;n++){const s=r(e,/cid\s+(-?\d+)/);e=s.rest;const t=r(e,/csid\s+([^\s]+)/);e=t.rest;const a=/name\s+([\s\S]*?)\s+team\b/,c=new RegExp(a.source,"m").exec(e);let i="";if(c){i=c[1]?.trim()??"";const E=c.index+c[0].length-4;e=e.slice(E)}else{const E=r(e,/name\s+([^\s]+)/);i=E.value||"",e=E.rest}const d=r(e,/team\s+(-?\d+)/);e=d.rest;const u=r(e,/color\s+(-?\d+)/);e=u.rest;const f=r(e,/lanid\s+(-?\d+)/);e=f.rest;const m=r(e,/startx\s+(-?\d+)/);e=m.rest;const p=r(e,/starty\s+(-?\d+)/);e=p.rest;const x=r(e,/aidifficulty\s+(-?\d+)/);e=x.rest;const v=r(e,/bexists\s+(true|false)/);e=v.rest;const I=r(e,/bai\s+(true|false)/);e=I.rest;const M=r(e,/bhuman\s+(true|false)/);e=M.rest;const S=r(e,/bclosed\s+(true|false)/);e=S.rest;const T=r(e,/bready\s+(true|false)/);e=T.rest;const w=r(e,/bloaded\s+(true|false)/);e=w.rest;const k=r(e,/bleave\s+(true|false)/);e=k.rest;const Q={id:n,cid:s.value?parseInt(s.value,10):NaN,csid:t.value||"",name:i||t.value||"",team:d.value?parseInt(d.value,10):0,color:u.value?parseInt(u.value,10):0,lanid:f.value?parseInt(f.value,10):0,startx:m.value?parseInt(m.value,10):0,starty:p.value?parseInt(p.value,10):0,aidifficulty:x.value?parseInt(x.value,10):0,bexists:v.value==="true",bai:I.value==="true",bhuman:M.value==="true",bclosed:S.value==="true",bready:T.value==="true",bloaded:w.value==="true",bleave:k.value==="true"};z.push(Q)}const H=q?.[1]??o,J=/(\* id \d+[\s\S]*?)(?=\* id |\bplayersinfo\b|$)/g;let F;const L=[];for(;(F=J.exec(H))!==null;)F[1]&&L.push(F[1]);const g=(n,s)=>{let t,a;const l=new RegExp(s.source,s.flags.includes("g")?s.flags:s.flags+"g");for(;(t=l.exec(n))!==null;)a=t[1];return a},B=[];for(let n=0;n<L.length;n++){const s=L[n];if(!s)continue;const t=s.match(/\* id (\-?\d+)/),a=g(s,/cid\s+(-?\d+)/g),l=s.match(/csid\s+([^\s]+)/),c=s.match(/name\s+([\s\S]*?)\s+team\b/),i=g(s,/team\s+(-?\d+)/g),d=g(s,/color\s+(-?\d+)/g),u=g(s,/lanid\s+(-?\d+)/g),f=g(s,/startx\s+(-?\d+)/g),m=g(s,/starty\s+(-?\d+)/g),p=g(s,/aidifficulty\s+(-?\d+)/g),x=s.match(/bexists\s+(true|false)/),v=s.match(/bai\s+(true|false)/),I=s.match(/bhuman\s+(true|false)/),M=s.match(/bclosed\s+(true|false)/),S=s.match(/bready\s+(true|false)/),T=s.match(/bloaded\s+(true|false)/),w=s.match(/bleave\s+(true|false)/),k={id:t?parseInt(t[1]??"0",10):n,cid:a!=null?parseInt(a,10):NaN,csid:l?l[1]??"":"",name:c?c[1]?.trim()??"":l?l[1]??"":"",team:i!=null?parseInt(i,10):0,color:d!=null?parseInt(d,10):0,lanid:u!=null?parseInt(u,10):0,startx:f!=null?parseInt(f,10):0,starty:m!=null?parseInt(m,10):0,aidifficulty:p!=null?parseInt(p,10):0,bexists:x?x[1]==="true":!1,bai:v?v[1]==="true":!1,bhuman:I?I[1]==="true":!1,bclosed:M?M[1]==="true":!1,bready:S?S[1]==="true":!1,bloaded:T?T[1]==="true":!1,bleave:w?w[1]==="true":!1};B.push(k)}const A=n=>n.reduce((s,t)=>s+(t.bexists?1:0),0),K=A(B)>A(z)?B:z;h.players.push(...K);const C=o.match(/\bplayersinfo\b([\s\S]*?)(?=\bPatternList\b|\bF\b|$)/),G=[];if(C){const n=C[1]??"",s=/(\* sic [\s\S]*?)(?=\* sic |\n\*|$)/g;let t;for(;(t=s.exec(n))!==null;){const a=t[1];if(!a)continue;const l=a.match(/sic\s+(\d+)/),c=a.match(/si1\s+(\d+)/),i=a.match(/si2\s+(\d+)/),d=a.match(/si3\s+(\d+)/),u=a.match(/snc\s+([^\s]+)/),f=a.match(/sn1\s+([^\s]+)/),m=a.match(/sn2\s+([^\s]+)/),p=a.match(/sn3\s+([^\s]+)/);G.push({sic:l?parseInt(l[1]||"0",10):0,si1:c?parseInt(c[1]||"0",10):0,si2:i?parseInt(i[1]||"0",10):0,si3:d?parseInt(d[1]||"0",10):0,snc:u?u[1]:void 0,sn1:f?f[1]:void 0,sn2:m?m[1]:void 0,sn3:p?p[1]:void 0})}}const U=new Set,D=n=>(n??"").replace(/%color\([^\)]*\)%/gi,"").replace(/\s+/g," ").trim().toLowerCase(),R=new Map;h.players.forEach((n,s)=>{const t=D(n.name);R.has(t)||R.set(t,[]);const a=R.get(t);a&&a.push(s)});let y=0;for(let n=0;n<G.length;n++){const s=G[n];if(!s)continue;let t=null;const a=D(s.snc);if(a){const l=R.get(a)??[];for(const c of l)if(!U.has(c)){t=c;break}}if(t===null){for(;y<h.players.length&&U.has(y);)y++;y<h.players.length?(t=y,y++):t=null}if(t!==null&&t>=0&&t<h.players.length){const l=h.players[t];l&&(l.sic=s.sic,l.si1=s.si1,l.si2=s.si2,l.si3=s.si3,l.snc=s.snc,l.sn1=s.sn1,l.sn2=s.sn2,l.sn3=s.sn3),U.add(t)}}o="";const O={fileName:N.name,status:"completed",data:h};self.postMessage(O)}catch(o){const b={fileName:N.name,status:"error",data:null,error:o?.message??"Unknown parsing error"};self.postMessage(b)}},P.onerror=()=>{const $={fileName:N.name,status:"error",data:null,error:"Error reading file"};self.postMessage($)},P.readAsText(N)}})();
