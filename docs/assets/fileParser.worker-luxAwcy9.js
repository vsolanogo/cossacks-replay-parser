!function(){"use strict";const s=/(?:^|\s)UID(\d+).*?gMap name (\S+).*?mapsize (\d+).*?terraintype (\d+).*?relieftype (\d+)/s;self.onmessage=e=>{const t=e.data,a=new FileReader;a.onload=e=>{try{let a=e.target?.result??"";a=a.replace(/[^ -~]+/g," ");const r=s.exec(a);if(!r)throw new Error("Game info not found in file");const n={gameId:r[1],gMapName:r[2],mapSize:parseInt(r[3],10),terrainType:parseInt(r[4],10),reliefType:parseInt(r[5],10),players:[]},l=a.match(/\bplayers\b([\s\S]*?)(?=\bplayersinfo\b|\bPatternList\b|\bF\b|$)/);let c=l?l[1]:a;const o=(s,e)=>{const t=new RegExp(e.source,e.flags.includes("g")?e.flags:e.flags+"g").exec(s);if(!t)return{value:"",rest:s};const a=t.index+t[0].length;return{value:t[1],rest:s.slice(a)}},i=[];for(let s=0;s<12;s++){const e=o(c,/cid\s+(-?\d+)/);c=e.rest;const t=o(c,/csid\s+([^\s]+)/);c=t.rest;const a=new RegExp(/name\s+([\s\S]*?)\s+team\b/.source,"m").exec(c);let r="";if(a){r=a[1].trim();const s=a.index+a[0].length-4;c=c.slice(s)}else{const s=o(c,/name\s+([^\s]+)/);r=s.value||"",c=s.rest}const n=o(c,/team\s+(-?\d+)/);c=n.rest;const l=o(c,/color\s+(-?\d+)/);c=l.rest;const u=o(c,/lanid\s+(-?\d+)/);c=u.rest;const d=o(c,/startx\s+(-?\d+)/);c=d.rest;const f=o(c,/starty\s+(-?\d+)/);c=f.rest;const p=o(c,/aidifficulty\s+(-?\d+)/);c=p.rest;const m=o(c,/bexists\s+(true|false)/);c=m.rest;const b=o(c,/bai\s+(true|false)/);c=b.rest;const g=o(c,/bhuman\s+(true|false)/);c=g.rest;const h=o(c,/bclosed\s+(true|false)/);c=h.rest;const v=o(c,/bready\s+(true|false)/);c=v.rest;const y=o(c,/bloaded\s+(true|false)/);c=y.rest;const I=o(c,/bleave\s+(true|false)/);c=I.rest;const x={id:s,cid:e.value?parseInt(e.value,10):NaN,csid:t.value||"",name:r||t.value||"",team:n.value?parseInt(n.value,10):0,color:l.value?parseInt(l.value,10):0,lanid:u.value?parseInt(u.value,10):0,startx:d.value?parseInt(d.value,10):0,starty:f.value?parseInt(f.value,10):0,aidifficulty:p.value?parseInt(p.value,10):0,bexists:"true"===m.value,bai:"true"===b.value,bhuman:"true"===g.value,bclosed:"true"===h.value,bready:"true"===v.value,bloaded:"true"===y.value,bleave:"true"===I.value};i.push(x)}const u=l?l[1]:a,d=/(\* id \d+[\s\S]*?)(?=\* id |\bplayersinfo\b|$)/g;let f;const p=[];for(;null!==(f=d.exec(u));)p.push(f[1]);const m=(s,e)=>{let t,a;const r=new RegExp(e.source,e.flags.includes("g")?e.flags:e.flags+"g");for(;null!==(t=r.exec(s));)a=t[1];return a},b=[];for(let s=0;s<p.length;s++){const e=p[s],t=e.match(/\* id (\-?\d+)/),a=m(e,/cid\s+(-?\d+)/g),r=e.match(/csid\s+([^\s]+)/),n=e.match(/name\s+([\s\S]*?)\s+team\b/),l=m(e,/team\s+(-?\d+)/g),c=m(e,/color\s+(-?\d+)/g),o=m(e,/lanid\s+(-?\d+)/g),i=m(e,/startx\s+(-?\d+)/g),u=m(e,/starty\s+(-?\d+)/g),d=m(e,/aidifficulty\s+(-?\d+)/g),f=e.match(/bexists\s+(true|false)/),g=e.match(/bai\s+(true|false)/),h=e.match(/bhuman\s+(true|false)/),v=e.match(/bclosed\s+(true|false)/),y=e.match(/bready\s+(true|false)/),I=e.match(/bloaded\s+(true|false)/),x=e.match(/bleave\s+(true|false)/),w={id:t?parseInt(t[1],10):s,cid:null!=a?parseInt(a,10):NaN,csid:r?r[1]:"",name:n?n[1].trim():r?r[1]:"",team:null!=l?parseInt(l,10):0,color:null!=c?parseInt(c,10):0,lanid:null!=o?parseInt(o,10):0,startx:null!=i?parseInt(i,10):0,starty:null!=u?parseInt(u,10):0,aidifficulty:null!=d?parseInt(d,10):0,bexists:!!f&&"true"===f[1],bai:!!g&&"true"===g[1],bhuman:!!h&&"true"===h[1],bclosed:!!v&&"true"===v[1],bready:!!y&&"true"===y[1],bloaded:!!I&&"true"===I[1],bleave:!!x&&"true"===x[1]};b.push(w)}const g=s=>s.reduce((s,e)=>s+(e.bexists?1:0),0),h=g(b)>g(i)?b:i;n.players.push(...h);const v=a.match(/\bplayersinfo\b([\s\S]*?)(?=\bPatternList\b|\bF\b|$)/),y=[];if(v){const s=v[1],e=/(\* sic [\s\S]*?)(?=\* sic |\n\*|$)/g;let t;for(;null!==(t=e.exec(s));){const s=t[1],e=s.match(/sic\s+(\d+)/),a=s.match(/si1\s+(\d+)/),r=s.match(/si2\s+(\d+)/),n=s.match(/si3\s+(\d+)/),l=s.match(/snc\s+([^\s]+)/),c=s.match(/sn1\s+([^\s]+)/),o=s.match(/sn2\s+([^\s]+)/),i=s.match(/sn3\s+([^\s]+)/);y.push({sic:e?parseInt(e[1],10):0,si1:a?parseInt(a[1],10):0,si2:r?parseInt(r[1],10):0,si3:n?parseInt(n[1],10):0,snc:l?l[1]:"",sn1:c?c[1]:"",sn2:o?o[1]:"",sn3:i?i[1]:""})}}const I=new Set,x=s=>(s??"").replace(/%color\([^\)]*\)%/gi,"").replace(/\s+/g," ").trim().toLowerCase(),w=new Map;n.players.forEach((s,e)=>{const t=x(s.name);w.has(t)||w.set(t,[]),w.get(t).push(e)});let S=0;for(let s=0;s<y.length;s++){const e=y[s];let t=null;const a=x(e.snc);if(a){const s=w.get(a)??[];for(const e of s)if(!I.has(e)){t=e;break}}if(null===t){for(;S<n.players.length&&I.has(S);)S++;S<n.players.length?(t=S,S++):t=null}if(null!==t&&t>=0&&t<n.players.length){const s=n.players[t];s.sic=e.sic,s.si1=e.si1,s.si2=e.si2,s.si3=e.si3,s.snc=e.snc||void 0,s.sn1=e.sn1||void 0,s.sn2=e.sn2||void 0,s.sn3=e.sn3||void 0,I.add(t)}}a="";const N={fileName:t.name,status:"completed",data:n};self.postMessage(N)}catch(a){const s={fileName:t.name,status:"error",data:null,error:a?.message??"Unknown parsing error"};self.postMessage(s)}},a.onerror=()=>{const s={fileName:t.name,status:"error",data:null,error:"Error reading file"};self.postMessage(s)},a.readAsText(t)}}();
