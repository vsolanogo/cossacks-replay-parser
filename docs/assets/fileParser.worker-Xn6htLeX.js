!function(){"use strict";const s=/(?:^|\s)UID(\d+).*?gMap name (\S+).*?mapsize (\d+).*?terraintype (\d+).*?relieftype (\d+)/s;self.onmessage=e=>{const t=e.data,a=new FileReader;a.onload=e=>{var a,l,n,r;try{let r=null!=(l=null==(a=e.target)?void 0:a.result)?l:"";r=r.replace(/[^ -~]+/g," ");const c=s.exec(r);if(!c)throw new Error("Game info not found in file");const o={gameId:c[1],gMapName:c[2],mapSize:parseInt(c[3],10),terrainType:parseInt(c[4],10),reliefType:parseInt(c[5],10),players:[]},u=r.match(/\bplayers\b([\s\S]*?)(?=\bplayersinfo\b|\bPatternList\b|\bF\b|$)/);let i=u?u[1]:r;const d=(s,e)=>{const t=new RegExp(e.source,e.flags.includes("g")?e.flags:e.flags+"g").exec(s);if(!t)return{value:"",rest:s};const a=t.index+t[0].length;return{value:t[1],rest:s.slice(a)}},f=[];for(let s=0;s<12;s++){const e=d(i,/cid\s+(-?\d+)/);i=e.rest;const t=d(i,/csid\s+([^\s]+)/);i=t.rest;const a=new RegExp(/name\s+([\s\S]*?)\s+team\b/.source,"m").exec(i);let l="";if(a){l=a[1].trim();const s=a.index+a[0].length-4;i=i.slice(s)}else{const s=d(i,/name\s+([^\s]+)/);l=s.value||"",i=s.rest}const n=d(i,/team\s+(-?\d+)/);i=n.rest;const r=d(i,/color\s+(-?\d+)/);i=r.rest;const c=d(i,/lanid\s+(-?\d+)/);i=c.rest;const o=d(i,/startx\s+(-?\d+)/);i=o.rest;const u=d(i,/starty\s+(-?\d+)/);i=u.rest;const p=d(i,/aidifficulty\s+(-?\d+)/);i=p.rest;const m=d(i,/bexists\s+(true|false)/);i=m.rest;const b=d(i,/bai\s+(true|false)/);i=b.rest;const g=d(i,/bhuman\s+(true|false)/);i=g.rest;const h=d(i,/bclosed\s+(true|false)/);i=h.rest;const v=d(i,/bready\s+(true|false)/);i=v.rest;const y=d(i,/bloaded\s+(true|false)/);i=y.rest;const I=d(i,/bleave\s+(true|false)/);i=I.rest;const x={id:s,cid:e.value?parseInt(e.value,10):NaN,csid:t.value||"",name:l||t.value||"",team:n.value?parseInt(n.value,10):0,color:r.value?parseInt(r.value,10):0,lanid:c.value?parseInt(c.value,10):0,startx:o.value?parseInt(o.value,10):0,starty:u.value?parseInt(u.value,10):0,aidifficulty:p.value?parseInt(p.value,10):0,bexists:"true"===m.value,bai:"true"===b.value,bhuman:"true"===g.value,bclosed:"true"===h.value,bready:"true"===v.value,bloaded:"true"===y.value,bleave:"true"===I.value};f.push(x)}const p=u?u[1]:r,m=/(\* id \d+[\s\S]*?)(?=\* id |\bplayersinfo\b|$)/g;let b;const g=[];for(;null!==(b=m.exec(p));)g.push(b[1]);const h=(s,e)=>{let t,a;const l=new RegExp(e.source,e.flags.includes("g")?e.flags:e.flags+"g");for(;null!==(t=l.exec(s));)a=t[1];return a},v=[];for(let s=0;s<g.length;s++){const e=g[s],t=e.match(/\* id (\-?\d+)/),a=h(e,/cid\s+(-?\d+)/g),l=e.match(/csid\s+([^\s]+)/),n=e.match(/name\s+([\s\S]*?)\s+team\b/),r=h(e,/team\s+(-?\d+)/g),c=h(e,/color\s+(-?\d+)/g),o=h(e,/lanid\s+(-?\d+)/g),u=h(e,/startx\s+(-?\d+)/g),i=h(e,/starty\s+(-?\d+)/g),d=h(e,/aidifficulty\s+(-?\d+)/g),f=e.match(/bexists\s+(true|false)/),p=e.match(/bai\s+(true|false)/),m=e.match(/bhuman\s+(true|false)/),b=e.match(/bclosed\s+(true|false)/),y=e.match(/bready\s+(true|false)/),I=e.match(/bloaded\s+(true|false)/),x=e.match(/bleave\s+(true|false)/),w={id:t?parseInt(t[1],10):s,cid:null!=a?parseInt(a,10):NaN,csid:l?l[1]:"",name:n?n[1].trim():l?l[1]:"",team:null!=r?parseInt(r,10):0,color:null!=c?parseInt(c,10):0,lanid:null!=o?parseInt(o,10):0,startx:null!=u?parseInt(u,10):0,starty:null!=i?parseInt(i,10):0,aidifficulty:null!=d?parseInt(d,10):0,bexists:!!f&&"true"===f[1],bai:!!p&&"true"===p[1],bhuman:!!m&&"true"===m[1],bclosed:!!b&&"true"===b[1],bready:!!y&&"true"===y[1],bloaded:!!I&&"true"===I[1],bleave:!!x&&"true"===x[1]};v.push(w)}const y=s=>s.reduce((s,e)=>s+(e.bexists?1:0),0),I=y(v)>y(f)?v:f;o.players.push(...I);const x=r.match(/\bplayersinfo\b([\s\S]*?)(?=\bPatternList\b|\bF\b|$)/),w=[];if(x){const s=x[1],e=/(\* sic [\s\S]*?)(?=\* sic |\n\*|$)/g;let t;for(;null!==(t=e.exec(s));){const s=t[1],e=s.match(/sic\s+(\d+)/),a=s.match(/si1\s+(\d+)/),l=s.match(/si2\s+(\d+)/),n=s.match(/si3\s+(\d+)/),r=s.match(/snc\s+([^\s]+)/),c=s.match(/sn1\s+([^\s]+)/),o=s.match(/sn2\s+([^\s]+)/),u=s.match(/sn3\s+([^\s]+)/);w.push({sic:e?parseInt(e[1],10):0,si1:a?parseInt(a[1],10):0,si2:l?parseInt(l[1],10):0,si3:n?parseInt(n[1],10):0,snc:r?r[1]:"",sn1:c?c[1]:"",sn2:o?o[1]:"",sn3:u?u[1]:""})}}const S=new Set,N=s=>(null!=s?s:"").replace(/%color\([^\)]*\)%/gi,"").replace(/\s+/g," ").trim().toLowerCase(),E=new Map;o.players.forEach((s,e)=>{const t=N(s.name);E.has(t)||E.set(t,[]),E.get(t).push(e)});let M=0;for(let s=0;s<w.length;s++){const e=w[s];let t=null;const a=N(e.snc);if(a){const s=null!=(n=E.get(a))?n:[];for(const e of s)if(!S.has(e)){t=e;break}}if(null===t){for(;M<o.players.length&&S.has(M);)M++;M<o.players.length?(t=M,M++):t=null}if(null!==t&&t>=0&&t<o.players.length){const s=o.players[t];s.sic=e.sic,s.si1=e.si1,s.si2=e.si2,s.si3=e.si3,s.snc=e.snc||void 0,s.sn1=e.sn1||void 0,s.sn2=e.sn2||void 0,s.sn3=e.sn3||void 0,S.add(t)}}r="";const R={fileName:t.name,status:"completed",data:o};self.postMessage(R)}catch(c){const s={fileName:t.name,status:"error",data:null,error:null!=(r=null==c?void 0:c.message)?r:"Unknown parsing error"};self.postMessage(s)}},a.onerror=()=>{const s={fileName:t.name,status:"error",data:null,error:"Error reading file"};self.postMessage(s)},a.readAsText(t)}}();
